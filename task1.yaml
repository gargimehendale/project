--- 
 - name: launch ec2 instance
   hosts: localhost
   vars:
     count: 2
     var: ec2.instances
   tasks:
      - copy:
          content: |
            [master]
            [node]
          dest: ./inventory
      - name: master
        ec2:
          key_name: newkey
          instance_type: t2.xlarge
          image: ami-02354e95b39ca8dec
          region: us-east-1
          group: securegroup
          count: 1
          wait: yes
          instance_tags: 
              Name: master
          user_data: |
                     #!/bin/bash
                     sudo useradd ansible
                     PASSWD="ansible"
                     sudo echo ${PASSWD} | passwd --stdin ansible
                     sudo echo "ansible ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
                     sudo sed -i 'PasswordAuthentication yes/s/^#//' /etc/ssh/sshd_config
                     sudo sed -i "s/PasswordAuthentication no/#PasswordAuthentication no/g" /etc/ssh/sshd_config
                     sudo systemctl restart sshd
        register: ec2
      - lineinfile:
         path: ./inventory
         line: "{{item.private_ip}} ansible_connection=ssh ansible_user=ansible ansible_ssh_pass=ansible"
         insertafter: "[master]"
         firstmatch: yes
        with_items: "{{ec2.instances}}"
      - name: node
        ec2:
          key_name: newkey
          instance_type: t2.xlarge
          image: ami-02354e95b39ca8dec
          region: us-east-1
          count: "{{count}}"
          group: securegroup
          wait: yes
          instance_tags:
              Name: node
          user_data: |
                     #!/bin/bash
                     sudo useradd ansible
                     PASSWD="ansible"
                     sudo echo ${PASSWD} | passwd --stdin ansible
                     sudo echo "ansible ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
                     sudo sed -i 'PasswordAuthentication yes/s/^#//' /etc/ssh/sshd_config
                     sudo sed -i "s/PasswordAuthentication no/#PasswordAuthentication no/g" /etc/ssh/sshd_config
                     sudo systemctl restart sshd
        register: ec21
      - lineinfile:
         path: ./inventory
         line: "{{item.private_ip}} ansible_connection=ssh ansible_user=ansible ansible_ssh_pass=ansible"
         insertafter: "[node]"
        with_items: "{{ec21.instances}}"
